<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./filtering.css" />
    <title>Data Entry System</title>
  </head>
  <body>
    <div>
      <div class="nav-bar">
        <div class="user-mode">
          <div class="button-logout-content">
            <form action="/logout" method="get">
              <button type="submit" class="button-logout">Log-out</button>
            </form>
          </div>
          <div id="user-mode-name">
            <p><%= username %></p>
          </div>
        </div>
        <div class="app-name-div">
          <h2 id="app-name">Data Entry System</h2>
        </div>
      </div>
      <div id="title-name-content">
        <p id="title-name">Filtering Condition :</p>
      </div>
      <div class="filtering-condition-content">
        <div class="filtering-condition-form">
          <form action="/filtered-result" method="post" id="filterForm">
            <div class="from-date-condition-content">
              <p id="from-date-condition-topic">From :</p>
              <input type="date" name="fromDateCondition" id="from-date-condition-input" required/>
             </div>
            <div class="to-date-condition-content">
              <p id="to-date-condition-topic">To :</p>
              <input type="date" name="toDateCondition" id="to-date-condition-input" required />
            </div>
            <div class="chart-condition-content">
              <p id="chart-Condition-topic"> Report :</p>
              <div id="chart-condition-select-content">
                <select name="chartCondition" id="chart-condition-input" required>
                  <option value="DPV (Defects Per Vehicle) Report">DPV (Defects Per Vehicle) Report</option>
                  <option value="Master Report">Master Report</option>
                  <option value="Pareto Report">Pareto Report</option>
                  <option value="Surface Summary">Surface Summary</option>
                  <option value="Body Fitting Summary">Body Fitting Summary</option>
                  <option value="Missing & Wrong Part Summary">Missing & Wrong Part Summary</option>
                  <option value="Welding Summary">Welding Summary</option>
                  <option value="Water Leak Summary">Water Leak Summary</option>
                </select>
              </div>
            </div>
          </div>
          <button type="button" id="filtering-condition-submit-button" onclick="validate()">Generate</button>
        </form>
      </div>
      <div class="report-content">
        <div id="report-topic">
          <p id="report-topic-data"></p>
        </div>
        <div class="report-content-data">

        </div>
      </div>
    </div>

    <script>
      function validate(){
        var filterForm = document.getElementById('filterForm')

        if (!filterForm.checkValidity()) {
          if (filterForm.reportValidity) {
            filterForm.reportValidity();
          } else {
            alert(msg.ieErrorForm);
          }
        } else {
          var reportContentData = document.getElementsByClassName("report-content-data")[0];
          var childNodes = reportContentData.childNodes;
          Object.values(childNodes).map((child) => child.remove())
          document.getElementById('report-topic-data').innerHTML = ''
          generateReport()
        }
      }

      function generateReport(){
        var report = document.getElementById('chart-condition-input').value;
        document.getElementById('report-topic').style.color = '#ffffff'
        document.getElementById('report-topic-data').innerHTML = document.getElementById('chart-condition-input').value
        switch(report){
          case 'DPV (Defects Per Vehicle) Report': dpv(); break;
          case 'Master Report': master(); break;
          case 'Pareto Report': pareto(); break;
          case 'Surface Summary': individualSummary('Surface',['Dent','Bump','Burrs','Spatters','Others']); break;
          case 'Body Fitting Summary': individualSummary('Body Fitting',['Body Fitting 1','Body Fitting 2','Body Fitting 3','Body Fitting Others']); break;
          case 'Missing & Wrong Part Summary': individualSummary('Missing & Wrong Part',['Missing Part', 'Wrong Part']); break;
          case 'Welding Summary': individualSummary('Welding', ['Welding Part 1','Welding Part 2','Welding Part 3','Welding Part Others']); break;
          case 'Water Leak Summary': individualSummary('Water Leak',['Water Leak 1','Water Leak 2','Water Leak Others']); break;
          default: break;
        }
      }

      function dpv(){
        var fromDate = document.getElementById('from-date-condition-input').value
        var toDate = document.getElementById('to-date-condition-input').value

        var querySender = {
          'UB': [`SELECT * FROM defect_table WHERE category='UNDER BODY' and defect='Surface';`,`SELECT * FROM defect_table WHERE category='UNDER BODY' and defect='Body Fitting';`,`SELECT * FROM defect_table WHERE category='UNDER BODY' and defect='Missing & Wrong Part';`,`SELECT * FROM defect_table WHERE category='UNDER BODY' and defect='Welding';`,`SELECT * FROM defect_table WHERE category='UNDER BODY' and defect='Water Leak';`],
          'MB': [`SELECT * FROM defect_table WHERE (category='LH MAIN BODY' or category='RH MAIN BODY') and defect='Surface'`,`SELECT * FROM defect_table WHERE (category='LH MAIN BODY' or category='RH MAIN BODY') and defect='Body Fitting'`,`SELECT * FROM defect_table WHERE (category='LH MAIN BODY' or category='RH MAIN BODY') and defect='Missing & Wrong Part'`,`SELECT * FROM defect_table WHERE (category='LH MAIN BODY' or category='RH MAIN BODY') and defect='Welding'`,`SELECT * FROM defect_table WHERE (category='LH MAIN BODY' or category='RH MAIN BODY') and defect='Water Leak'`],
          'SB SA': [`SELECT * FROM defect_table WHERE (category='LH SHELL BODY SUB-LINE' or category='RH SHELL BODY SUB-LINE') and defect='Surface'`,`SELECT * FROM defect_table WHERE (category='LH SHELL BODY SUB-LINE' or category='RH SHELL BODY SUB-LINE') and defect='Body Fitting'`,`SELECT * FROM defect_table WHERE (category='LH SHELL BODY SUB-LINE' or category='RH SHELL BODY SUB-LINE') and defect='Missing & Wrong Part'`,`SELECT * FROM defect_table WHERE (category='LH SHELL BODY SUB-LINE' or category='RH SHELL BODY SUB-LINE') and defect='Welding'`,`SELECT * FROM defect_table WHERE (category='LH SHELL BODY SUB-LINE' or category='RH SHELL BODY SUB-LINE') and defect='Water Leak'`],
          'SB ML': [`SELECT * FROM defect_table WHERE (category='LH SHELL BODY MAIN-LINE' or category='RH SHELL BODY MAIN-LINE') and defect='Surface'`,`SELECT * FROM defect_table WHERE (category='LH SHELL BODY MAIN-LINE' or category='RH SHELL BODY MAIN-LINE') and defect='Body Fitting'`,`SELECT * FROM defect_table WHERE (category='LH SHELL BODY MAIN-LINE' or category='RH SHELL BODY MAIN-LINE') and defect='Missing & Wrong Part'`,`SELECT * FROM defect_table WHERE (category='LH SHELL BODY MAIN-LINE' or category='RH SHELL BODY MAIN-LINE') and defect='Welding'`,`SELECT * FROM defect_table WHERE (category='LH SHELL BODY MAIN-LINE' or category='RH SHELL BODY MAIN-LINE') and defect='Water Leak'`],
          'SM': [`SELECT * FROM defect_table WHERE (category='LEFT SIDE MEMBER' or category='RH SIDE MEMBER') and defect='Surface'`,`SELECT * FROM defect_table WHERE (category='LEFT SIDE MEMBER' or category='RH SIDE MEMBER') and defect='Body Fitting'`,`SELECT * FROM defect_table WHERE (category='LEFT SIDE MEMBER' or category='RH SIDE MEMBER') and defect='Missing & Wrong Part'`,`SELECT * FROM defect_table WHERE (category='LEFT SIDE MEMBER' or category='RH SIDE MEMBER') and defect='Welding'`,`SELECT * FROM defect_table WHERE (category='LEFT SIDE MEMBER' or category='RH SIDE MEMBER') and defect='Water Leak'`],
        }
        
        fetch('http://localhost:8000/reportDataProvider', {
          method: 'POST',
          headers: {
            'Content-type': 'application/json'
          },
          body: JSON.stringify({
            querySender,
            fromDate,
            toDate,
          })
        }).then((response) => response.json()).then((data) => {
          console.log(data.data)

          document.getElementById('report-topic-data').innerHTML = document.getElementById('chart-condition-input').value

          var reportContentData = document.getElementsByClassName('report-content-data')
          reportContentData[0].style.color = '#ffffff'


          var tbl = document.createElement('table');
          tbl.style.width = '100%';
          tbl.setAttribute('border', '1');
          reportContentData[0].appendChild(tbl)

          var tblRowforHeading = document.createElement('tr')
          tbl.appendChild(tblRowforHeading)

          var tableHeading = ['Section','Surface','Body Fitting','Missing & Wrong Part', 'Welding', 'Water Leak', 'Total', 'Total DPV']

          for(let i of tableHeading){
            var tblHeading = document.createElement('th')
            tblHeading.innerHTML = i
            tblRowforHeading.appendChild(tblHeading)
          }

          var horizontalTotalArray = [0,0,0,0,0]
          var horizontalTotalDPVArray = [0,0,0,0,0]
          var individualDefectTotal = [0,0,0,0,0]


          var i=0;

          for(let [key,value] of Object.entries(data.data)){
            var tblRowforData = document.createElement('tr')
            tbl.appendChild(tblRowforData)

            var tblDataforDefectName = document.createElement('td')
            tblDataforDefectName.innerHTML = key
            tblRowforData.appendChild(tblDataforDefectName)

            for(let j=0; j< value.length; j++){
              var tblDataforDefectName = document.createElement('td')
              tblDataforDefectName.innerHTML = value[j]
              tblRowforData.appendChild(tblDataforDefectName)

              horizontalTotalArray[i] += value[j]

              individualDefectTotal[j] += value[j]
            }
            var tblDataforTotal = document.createElement('td')
            tblDataforTotal.innerHTML = horizontalTotalArray[i]
            tblRowforData.appendChild(tblDataforTotal)

            var tblDataforTotalDPV = document.createElement('td')
            horizontalTotalDPVArray[i] = (horizontalTotalArray[i]/data.uniqueBodyNumberData.length)
            tblDataforTotalDPV.innerHTML = horizontalTotalDPVArray[i].toFixed(2)
            tblRowforData.appendChild(tblDataforTotalDPV)

            i++;
          }

          var tblRowforTotal = document.createElement('tr')
          tbl.appendChild(tblRowforTotal)

          var tblDataforTotal = document.createElement('td')
          tblDataforTotal.innerHTML = 'Total'
          tblRowforTotal.appendChild(tblDataforTotal)

          for(let j = 0; j < individualDefectTotal.length; j++){
            var tblDataforIndividualDefect = document.createElement('td')
            tblDataforIndividualDefect.innerHTML = individualDefectTotal[j]
            tblRowforTotal.appendChild(tblDataforIndividualDefect) 
          }

          var tblDataforHorizontalTotal = document.createElement('td')
          const horizontalTotal = horizontalTotalArray.reduce((partialSum, a) => partialSum + a, 0);
          tblDataforHorizontalTotal.innerHTML = horizontalTotal
          tblRowforTotal.appendChild(tblDataforHorizontalTotal)

          var tblDataforHorizontalTotalDPV = document.createElement('td')
          const horizontalTotalDPV = horizontalTotalDPVArray.reduce((partialSum, a) => partialSum + a, 0);
          tblDataforHorizontalTotalDPV.innerHTML = horizontalTotalDPV.toFixed(2)
          tblRowforTotal.appendChild(tblDataforHorizontalTotalDPV)

          var tblRowforProduction = document.createElement('tr')
          tbl.appendChild(tblRowforProduction)

          var tblDataforProduction = document.createElement('td')
          tblDataforProduction.colSpan = 7
          tblDataforProduction.innerHTML = 'Line off(Production)'
          tblRowforProduction.appendChild(tblDataforProduction)

          var tblDataforBodyNumbers = document.createElement('td')
          tblDataforBodyNumbers.innerHTML = data.uniqueBodyNumberData.length
          tblRowforProduction.appendChild(tblDataforBodyNumbers)

        }).catch((error) => {
          console.log(error)
        })
      }

     async function master(){
        var fromDate = document.getElementById('from-date-condition-input').value
        var toDate = document.getElementById('to-date-condition-input').value

        var querySender = {
          'UB': [`SELECT * FROM defect_table WHERE category='UNDER BODY' and defect='Surface';`,`SELECT * FROM defect_table WHERE category='UNDER BODY' and defect='Body Fitting';`,`SELECT * FROM defect_table WHERE category='UNDER BODY' and defect='Missing & Wrong Part';`,`SELECT * FROM defect_table WHERE category='UNDER BODY' and defect='Welding';`,`SELECT * FROM defect_table WHERE category='UNDER BODY' and defect='Water Leak';`],
          'MB': [`SELECT * FROM defect_table WHERE (category='LH MAIN BODY' or category='RH MAIN BODY') and defect='Surface'`,`SELECT * FROM defect_table WHERE (category='LH MAIN BODY' or category='RH MAIN BODY') and defect='Body Fitting'`,`SELECT * FROM defect_table WHERE (category='LH MAIN BODY' or category='RH MAIN BODY') and defect='Missing & Wrong Part'`,`SELECT * FROM defect_table WHERE (category='LH MAIN BODY' or category='RH MAIN BODY') and defect='Welding'`,`SELECT * FROM defect_table WHERE (category='LH MAIN BODY' or category='RH MAIN BODY') and defect='Water Leak'`],
          'SB SA': [`SELECT * FROM defect_table WHERE (category='LH SHELL BODY SUB-LINE' or category='RH SHELL BODY SUB-LINE') and defect='Surface'`,`SELECT * FROM defect_table WHERE (category='LH SHELL BODY SUB-LINE' or category='RH SHELL BODY SUB-LINE') and defect='Body Fitting'`,`SELECT * FROM defect_table WHERE (category='LH SHELL BODY SUB-LINE' or category='RH SHELL BODY SUB-LINE') and defect='Missing & Wrong Part'`,`SELECT * FROM defect_table WHERE (category='LH SHELL BODY SUB-LINE' or category='RH SHELL BODY SUB-LINE') and defect='Welding'`,`SELECT * FROM defect_table WHERE (category='LH SHELL BODY SUB-LINE' or category='RH SHELL BODY SUB-LINE') and defect='Water Leak'`],
          'SB ML': [`SELECT * FROM defect_table WHERE (category='LH SHELL BODY MAIN-LINE' or category='RH SHELL BODY MAIN-LINE') and defect='Surface'`,`SELECT * FROM defect_table WHERE (category='LH SHELL BODY MAIN-LINE' or category='RH SHELL BODY MAIN-LINE') and defect='Body Fitting'`,`SELECT * FROM defect_table WHERE (category='LH SHELL BODY MAIN-LINE' or category='RH SHELL BODY MAIN-LINE') and defect='Missing & Wrong Part'`,`SELECT * FROM defect_table WHERE (category='LH SHELL BODY MAIN-LINE' or category='RH SHELL BODY MAIN-LINE') and defect='Welding'`,`SELECT * FROM defect_table WHERE (category='LH SHELL BODY MAIN-LINE' or category='RH SHELL BODY MAIN-LINE') and defect='Water Leak'`],
          'SM': [`SELECT * FROM defect_table WHERE (category='LEFT SIDE MEMBER' or category='RH SIDE MEMBER') and defect='Surface'`,`SELECT * FROM defect_table WHERE (category='LEFT SIDE MEMBER' or category='RH SIDE MEMBER') and defect='Body Fitting'`,`SELECT * FROM defect_table WHERE (category='LEFT SIDE MEMBER' or category='RH SIDE MEMBER') and defect='Missing & Wrong Part'`,`SELECT * FROM defect_table WHERE (category='LEFT SIDE MEMBER' or category='RH SIDE MEMBER') and defect='Welding'`,`SELECT * FROM defect_table WHERE (category='LEFT SIDE MEMBER' or category='RH SIDE MEMBER') and defect='Water Leak'`],
        }
        
        const response = await fetch('http://localhost:8000/reportDataProvider', {
          method: 'POST',
          headers: {
            'Content-type': 'application/json'
          },
          body: JSON.stringify({
            querySender,
            fromDate,
            toDate,
          })
        })
        const data = await response.json();
        
        document.getElementById('report-topic-data').innerHTML = document.getElementById('chart-condition-input').value
        var reportContentData = document.getElementsByClassName('report-content-data')
        reportContentData[0].style.color = '#ffffff'

        var tableHeading = ['Section','Surface','Body Fitting','Missing & Wrong Part', 'Welding', 'Water Leak', 'Total', 'Total DPV']

        var horizontalTotalArray = [0,0,0,0,0]
        var horizontalTotalDPVArray = [0,0,0,0,0]
        var individualDefectTotal = [0,0,0,0,0]

        var i=0;
        for(let [key,value] of Object.entries(data.data)){
          for(let j=0; j< value.length; j++){
            horizontalTotalArray[i] += value[j]
            individualDefectTotal[j] += value[j]
          }
          horizontalTotalDPVArray[i] = (horizontalTotalArray[i]/data.uniqueBodyNumberData.length)
          i++;
        }

        const horizontalTotal = horizontalTotalArray.reduce((partialSum, a) => partialSum + a, 0);
        const horizontalTotalDPV = horizontalTotalDPVArray.reduce((partialSum, a) => partialSum + a, 0);


        console.log(individualDefectTotal,data.data,horizontalTotal, horizontalTotalDPV)
      }


      function pareto(){ 
        document.getElementById('report-topic-data').innerHTML = document.getElementById('chart-condition-input').value
        console.log('pareto');
      }
      function individualSummary(majorDefectName, minorDefectsList){
        document.getElementById('report-topic-data').innerHTML = document.getElementById('chart-condition-input').value
        console.log(SummaryName);

        var fromDate = document.getElementById('from-date-condition-input').value
        var toDate = document.getElementById('to-date-condition-input').value

        fetch('http://localhost:8000/individualSummaryReport',{
          method: 'POST',
          headers:{
            'Content-type': 'application/json'
          },
          body: JSON.stringify({
            majorDefectName,
            minorDefectsList,
            fromDate,
            toDate
          })
        })
      }
    </script>

  </body>
</html>
